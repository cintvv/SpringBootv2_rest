<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Users</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
    }
    .sidebar {
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      margin-top: 64px;
      width: 200px;
    }
    .sidebar a {
      display: block;
      color: white;
      padding: 10px 15px;
      text-decoration: none;
      font-size: 18px;
    }
    .sidebar a:hover {
      background-color: #007bff;
    }
    .content {
      margin-left: 220px;
      padding-top: 60px;
    }
    .navbar {
      background-color: #343a40;
      padding: 20px;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .btn-edit {
      background-color: #17a2b8;
      color: white;
    }
    .btn-delete {
      background-color: #dc3545;
      color: white;
    }
    .active {
      background-color: #007bff;
      color: white;
    }
    .table-container {
      margin: 0px auto;
      width: 100%;
    }
    .form-control {
      color: #212529;
      background-color: #ffffff;
    }
  </style>
</head>
<body>

<div class="content">
  <div class="navbar">
    <span><strong th:text="${#authentication.name}">USERNAME</strong> with roles:
      <span th:each="roles : ${#authentication.getAuthorities()}" th:text="${roles} + ' '">WHERE ROLES?</span></span>
    <a href="#" th:href="@{/logout}">Logout</a>
    <div class="sidebar">
      <a th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}" th:classappend="${currentPath == '/admin'} ? 'active'" th:href="@{/admin}">Admin</a>
      <a th:classappend="${currentPath == '/user'} ? 'active'" th:href="@{/user}">User</a>
    </div>
  </div>

  <h1 class="my-4">Admin panel</h1>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link active" href="#">Users table</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}" data-toggle="modal" data-target="#newUserModal">New User</a>
    </li>
  </ul>

  <input class="form-control" type="text" placeholder="All Users" readonly>
  <div class="table-container">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
      <tr>
        <th>USERNAME</th>
        <th>AVATAR</th>
        <th>EMAIL</th>
        <th>PHONE</th>
        <th>ROLES</th>
        <th th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}">Edit</th>
        <th th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}">Delete</th>
      </tr>
      </thead>
      <tbody id="userTableBody">
      </tbody>
    </table>
  </div>
</div>

<div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Редактировать пользователя</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="editUserForm">
          <div class="form-group">
            <label for="editUsername">USERNAME:</label>
            <input type="text" class="form-control" id="editUsername" name="username" required />
          </div>
          <div class="form-group">
            <label for="editEmail">EMAIL:</label>
            <input type="email" class="form-control" id="editEmail" name="email" required />
          </div>
          <div class="form-group">
            <label for="editPhone">PHONE:</label>
            <input type="tel" class="form-control" id="editPhone" name="phone" required />
          </div>
          <div class="form-group">
            <label for="editPassword">PASSWORD:</label>
            <input type="password" class="form-control" id="editPassword" name="password" />
          </div>
          <div class="form-group">
            <label for="editAvatar">AVATAR URL:</label>
            <input type="url" class="form-control" id="editAvatar" name="avatar" required />
          </div>
          <div class="form-group">
            <label>Роли:</label>
            <div id="rolesContainer">
            </div>
          </div>
          <div class="form-group">
            <input type="submit" value="Сохранить!" class="btn btn-primary" />
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1" role="dialog" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteUserModalLabel">Подтверждение удаления</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        Вы уверены, что хотите удалить пользователя <strong id="deleteUsername"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Отмена</button>
        <button id="confirmDelete" class="btn btn-danger">Удалить</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="newUserModal" tabindex="-1" role="dialog" aria-labelledby="newUserModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newUserModalLabel">Добавить нового пользователя</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="newUserForm">
          <div class="form-group">
            <label for="newUsername">USERNAME:</label>
            <input type="text" class="form-control" id="newUsername" name="username" required title="Если не уникально, к нему будет добавлено +1"
                   placeholder="Если не уникально, добавится +1" />
          </div>
          <div class="form-group">
            <label for="newEmail">EMAIL:</label>
            <input type="email" class="form-control" id="newEmail" name="email" required placeholder="mail@mail.com"/>
          </div>
          <div class="form-group">
            <label for="newPhone">PHONE:</label>
            <input type="tel" class="form-control" id="newPhone" name="phone" required pattern="^\+7 \d{3} \d{3} \d{2} \d{2}$"
                   title="Формат: +7 999 999 99 99"
                   placeholder="+7 999 999 99 99"/>
          </div>
          <div class="form-group">
            <label for="newPassword">PASSWORD:</label>
            <input type="password" class="form-control" id="newPassword" name="password" required placeholder="*********"/>
          </div>
          <div class="form-group">
            <label for="newAvatar">AVATAR URL:</label>
            <input type="url" class="form-control" id="newAvatar" name="avatar" required pattern="https?://.*\.(jpg|jpeg|png|gif)$"
                   title="Формат: только URL изображения (например, https://oxfraud.cc/image.jpg)"
                   placeholder="https://oxfraud.cc/image.jpg"/>
          </div>
          <div class="form-group">
            <label>Роли:</label>
            <div class="roles-container">
            </div>
          </div>
          <div class="form-group">
            <input type="submit" value="Сохранить!" class="btn btn-primary" />
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    function loadUsers() {
      fetch('/api/admin/list')
              .then(response => response.json())
              .then(users => {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
              <td>${user.username}</td>
              <td><img src="${user.avatar}" alt="User Avatar" style="width: 150px; height: 150px; border-radius: 50%;"></td>
              <td>${user.email}</td>
              <td>${user.phone}</td>
              <td>${user.roles.map(role => role.name).join(', ')}</td>
              <td>
                <button class="btn btn-edit btn-sm" data-toggle="modal" data-target="#editUserModal"
                  data-username="${user.username}" data-email="${user.email}" data-phone="${user.phone}"
                  data-avatar="${user.avatar}" data-roles="${user.roles.map(role => role.id).join(',')}">Edit</button>
              </td>
              <td>
                <button class="btn btn-delete btn-sm" data-toggle="modal" data-target="#deleteUserModal" data-username="${user.username}">Delete</button>
              </td>
            `;
                  tbody.appendChild(row);
                });

                const editButtons = document.querySelectorAll('.btn-edit');
                editButtons.forEach(button => {
                  button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const email = this.getAttribute('data-email');
                    const phone = this.getAttribute('data-phone');
                    const avatar = this.getAttribute('data-avatar');
                    const roles = this.getAttribute('data-roles').split(',');

                    document.getElementById('editUsername').value = username;
                    document.getElementById('editEmail').value = email;
                    document.getElementById('editPhone').value = phone;
                    document.getElementById('editAvatar').value = avatar;

                    const roleCheckboxes = document.querySelectorAll('#rolesContainer input[type="checkbox"]');
                    roleCheckboxes.forEach(checkbox => {
                      checkbox.checked = roles.includes(checkbox.value);
                    });
                  });
                });

                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(button => {
                  button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    document.getElementById('deleteUsername').textContent = username;
                  });
                });
              });
    }

    function loadRoles() {
      fetch('/api/roles')
              .then(response => response.json())
              .then(roles => {
                const rolesContainer = document.getElementById('rolesContainer');
                rolesContainer.innerHTML = '';
                roles.forEach(role => {
                  rolesContainer.innerHTML += `
              <label>
                <input type="checkbox" name="roles" value="${role.id}" />
                <span>${role.name}</span>
              </label>
            `;
                });
              });
    }

    loadUsers();
    loadRoles();

    document.getElementById('confirmDelete').addEventListener('click', function() {
      const username = document.getElementById('deleteUsername').textContent.trim();
      if (!username) {
        alert("Имя пользователя не указано");
        return;
      }

      fetch(`/api/admin/${username}`, { method: 'DELETE' })
              .then(response => {
                if (response.ok) {
                  alert(`Пользователь ${username} успешно удален`);
                  loadUsers();
                  $('#deleteUserModal').modal('hide');
                } else {
                  throw new Error(`Ошибка: ${response.status}`);
                }
              })
              .catch(error => {
                alert(error.message);
              });
    });

    document.getElementById('editUserForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const formData = new FormData(this);
      const userData = Object.fromEntries(formData.entries());

      const selectedRoles = Array.from(document.querySelectorAll('#rolesContainer input[type="checkbox"]:checked'))
              .map(checkbox => ({ id: checkbox.value }));

      userData.roles = selectedRoles;

      fetch(`/api/admin/update`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      })
              .then(response => {
                if (response.ok) {
                  return response.json();
                } else {
                  throw new Error('Ошибка при обновлении пользователя');
                }
              })
              .then(user => {
                alert(`Пользователь ${user.username} обновлен успешно`);
                loadUsers();
                $('#editUserModal').modal('hide');
              })
              .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось обновить пользователя.');
              });
    });

    document.getElementById('newUserForm').addEventListener('submit', function(event) {
      event.preventDefault();

      const formData = new FormData(this);
      const userData = Object.fromEntries(formData.entries());

      const selectedRoles = Array.from(document.querySelectorAll('.roles-container input[type="checkbox"]:checked'))
              .map(checkbox => ({ id: checkbox.value }));

      userData.roles = selectedRoles;

      fetch('/api/admin/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(userData)
      })
              .then(response => {
                return response.text();
              })
              .then(result => {
                alert(result);
                loadUsers();
                $('#newUserModal').modal('hide');
              })
              .catch(error => {
                console.error('Ошибка:', error);
                alert('Не удалось добавить пользователя.');
              });
    });

    $('#newUserModal').on('show.bs.modal', function () {
      var modal = $(this);
      var rolesContainer = modal.find('.roles-container');

      rolesContainer.empty();

      $.ajax({
        url: '/api/roles',
        method: 'GET',
        success: function(data) {
          $.each(data, function(index, role) {
            rolesContainer.append(
                    '<label><input type="checkbox" name="roles" value="' + role.id + '"> ' + role.name + '</label><br>'
            );
          });
        },
        error: function(error) {
          console.log('Error loading roles:', error);
        }
      });
    });
  });
</script>


</body>
</html>
