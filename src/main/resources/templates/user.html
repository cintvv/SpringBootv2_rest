<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Users</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f9fa;
    }
    .sidebar {
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      background-color: #343a40;
      margin-top: 64px;
      width: 200px;
    }
    .sidebar a {
      display: block;
      color: white;
      padding: 10px 15px;
      text-decoration: none;
      font-size: 18px;
    }
    .sidebar a:hover {
      background-color: #007bff;
    }
    .content {
      margin-left: 220px;
      padding-top: 60px;
    }
    .navbar {
      background-color: #343a40;
      padding: 20px;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
    }
    .btn-edit {
      background-color: #17a2b8;
      color: white;
    }
    .btn-delete {
      background-color: #dc3545;
      color: white;
    }
    .active {
      background-color: #007bff;
      color: white;
    }
    .table-container {
      margin: 0px auto;
      width: 100%;
    }
    .form-control {
      color: #212529;
      background-color: #ffffff;
    }
  </style>
</head>
<body>

<div class="content">
  <div class="navbar">
    <span><strong th:text="${#authentication.name}">USERNAME</strong> with roles:
      <span th:each="roles : ${#authentication.getAuthorities()}" th:text="${roles} + ' '">WHERE ROLES?</span></span>
    <a href="#" th:href="@{/logout}">Logout</a>
    <div class="sidebar">
      <a th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}" th:classappend="${currentPath == '/admin'} ? 'active'" th:href="@{/admin}">Admin</a>
      <a th:classappend="${currentPath == '/user'} ? 'active'" th:href="@{/user}">User</a>
    </div>
  </div>

  <h1 class="my-4">Admin panel</h1>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link active" href="#">Users table</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" th:if="${#authorization.expression('(hasRole(''ROLE_ADMIN'') and hasRole(''ROLE_USER'')) or hasRole(''ROLE_ADMIN'')')}" data-toggle="modal" data-target="#newUserModal">New User</a>
    </li>
  </ul>

  <input class="form-control" type="text" placeholder="All Users" readonly>
  <div class="table-container">
    <table class="table table-bordered table-striped">
      <thead class="thead-dark">
      <tr>
        <th>USERNAME</th>
        <th>AVATAR</th>
        <th>EMAIL</th>
        <th>PHONE</th>
        <th>ROLES</th>
      </tr>
      </thead>
      <tbody id="userTableBody">
      </tbody>
    </table>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    function loadUsers() {
      fetch('/api/user/list')
              .then(response => response.json())
              .then(users => {
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = '';

                users.forEach(user => {
                  const row = document.createElement('tr');
                  row.innerHTML = `
              <td>${user.username}</td>
              <td><img src="${user.avatar}" alt="User Avatar" style="width: 150px; height: 150px; border-radius: 50%;"></td>
              <td>${user.email}</td>
              <td>${user.phone}</td>
              <td>${user.roles.map(role => role.name).join(', ')}</td>
            `;
                  tbody.appendChild(row);
                });

                const editButtons = document.querySelectorAll('.btn-edit');
                editButtons.forEach(button => {
                  button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const email = this.getAttribute('data-email');
                    const phone = this.getAttribute('data-phone');
                    const avatar = this.getAttribute('data-avatar');
                    const roles = this.getAttribute('data-roles').split(',');

                    document.getElementById('editUsername').value = username;
                    document.getElementById('editEmail').value = email;
                    document.getElementById('editPhone').value = phone;
                    document.getElementById('editAvatar').value = avatar;

                    const roleCheckboxes = document.querySelectorAll('#rolesContainer input[type="checkbox"]');
                    roleCheckboxes.forEach(checkbox => {
                      checkbox.checked = roles.includes(checkbox.value);
                    });
                  });
                });

                const deleteButtons = document.querySelectorAll('.btn-delete');
                deleteButtons.forEach(button => {
                  button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    document.getElementById('deleteUsername').textContent = username;
                  });
                });
              });
    }

    function loadRoles() {
      fetch('/api/roles')
              .then(response => response.json())
              .then(roles => {
                const rolesContainer = document.getElementById('rolesContainer');
                rolesContainer.innerHTML = '';
                roles.forEach(role => {
                  rolesContainer.innerHTML += `
              <label>
                <input type="checkbox" name="roles" value="${role.id}" />
                <span>${role.name}</span>
              </label>
            `;
                });
              });
    }

    loadUsers();
    loadRoles();
  });
</script>
</body>
</html>
